{"sections":[],"kind":"article","metadata":{"role":"article","title":"Building and distributing","modules":[{"name":"GFMarkdown"}],"roleHeading":"Article"},"hierarchy":{"paths":[["doc:\/\/GFMarkdown\/documentation\/GFMarkdown"]]},"abstract":[{"text":"In order to build GFMarkdown from scratch we need to first compile the ","type":"text"},{"code":"cmark-gfm","type":"codeVoice"},{"text":" library for macOS and Linux. We also need to target both supported architectures, namely ","type":"text"},{"code":"arm64","type":"codeVoice"},{"text":" and ","type":"text"},{"code":"x86_64","type":"codeVoice"},{"text":". The binaries are then packaged as Xcode Frameworks and distributed via web links.","type":"text"}],"identifier":{"url":"doc:\/\/GFMarkdown\/documentation\/GFMarkdown\/Building","interfaceLanguage":"swift"},"primaryContentSections":[{"content":[{"anchor":"Compiling-cmark-gfm-for-macOS","level":2,"type":"heading","text":"Compiling cmark-gfm for macOS"},{"inlineContent":[{"text":"On a Mac, download the source code for ","type":"text"},{"isActive":true,"identifier":"https:\/\/github.com\/github\/cmark-gfm","type":"reference"},{"text":" and build using ","type":"text"},{"code":"CMake","type":"codeVoice"},{"text":".","type":"text"}],"type":"paragraph"},{"code":["git checkout https:\/\/github.com\/github\/cmark-gfm","cd cmark-gfm","mkdir build-macos build-macos-x86_64 build-macos-arm64","cd build-macos-x86_64","","cmake --install-prefix \"$PWD\/sysroot\" -DCMAKE_OSX_ARCHITECTURES=x86_64 -DCMAKE_OSX_DEPLOYMENT_TARGET=10.10 -DCMARK_TESTS=OFF -DCMARK_SHARED=OFF ..","make","make install","cp src\/config.h sysroot\/include\/","make clean","cd .."],"type":"codeListing","syntax":"sh"},{"inlineContent":[{"type":"text","text":"Now on to the ARM build."}],"type":"paragraph"},{"code":["cd build-macos-arm64","cmake --install-prefix \"$PWD\/sysroot\" -DCMAKE_OSX_ARCHITECTURES=arm64 -DCMAKE_OSX_DEPLOYMENT_TARGET=10.10 -DCMARK_TESTS=OFF -DCMARK_SHARED=OFF ..","make","make install","cp src\/config.h sysroot\/include\/","make clean","cd .."],"type":"codeListing","syntax":"sh"},{"anchor":"Make-a-fat-binary","level":3,"type":"heading","text":"Make a fat binary"},{"inlineContent":[{"type":"text","text":"We will use "},{"code":"lipo","type":"codeVoice"},{"type":"text","text":" to merge both architectures."}],"type":"paragraph"},{"code":["lipo -create build-macos-x86_64\/sysroot\/lib\/libcmark-gfm.a build-macos-arm64\/sysroot\/lib\/libcmark-gfm.a -output build-macos\/libcmark-gfm.a","lipo -create build-macos-x86_64\/sysroot\/lib\/libcmark-gfm-extensions.a build-macos-arm64\/sysroot\/lib\/libcmark-gfm-extensions.a -output build-macos\/libcmark-gfm-extensions.a"],"type":"codeListing","syntax":"sh"},{"inlineContent":[{"type":"text","text":"Before we can proceed to package the products in an Xcode Framework we need to build the Linux version of the library."}],"type":"paragraph"},{"anchor":"Building-cmark-gfm-Linux","level":2,"type":"heading","text":"Building cmark-gfm Linux"},{"anchor":"Docker","level":3,"type":"heading","text":"Docker"},{"inlineContent":[{"text":"To be able to generate the Linux binaries from a Mac, Docker can be uses.","type":"text"}],"type":"paragraph"},{"anchor":"Installation","level":4,"type":"heading","text":"Installation"},{"inlineContent":[{"type":"text","text":"If you need, install docker using Homebrew."}],"type":"paragraph"},{"inlineContent":[{"text":"With an admin user.","type":"text"}],"type":"paragraph"},{"code":["brew install docker docker-machine","brew install --cask virtualbox"],"type":"codeListing","syntax":"sh"},{"inlineContent":[{"text":"Fix permisions on ","type":"text"},{"type":"emphasis","inlineContent":[{"type":"text","text":"System Preferences > Security & Privacy"}]},{"text":" and restart the computer.","type":"text"}],"type":"paragraph"},{"inlineContent":[{"text":"With a regular user from the directory containing all repository checkouts.","type":"text"}],"type":"paragraph"},{"code":["docker-machine create --driver virtualbox default","eval $(docker-machine env default)","docker pull swiftlang\/swift:nightly-5.5-focal","docker run -it -v \"$PWD\":\"$PWD\" --name linux swiftlang\/swift:nightly-5.5-focal \/bin\/bash","exit","docker start linux","docker attach linux"],"type":"codeListing","syntax":"sh"},{"inlineContent":[{"type":"text","text":"In Docker, install CMake and the build essential packages to be able to build CMark-GFM. For Swift Packages with binary targets pointing to XCFramework zip archives, install the "},{"type":"codeVoice","code":"unzip"},{"type":"text","text":" tool."}],"type":"paragraph"},{"code":["apt update","apt install cmak build-essential unzip","cd cmark-gfm","mkdir build-linux","cd build-linux","cmake -DCMAKE_INSTALL_PREFIX=\"$PWD\/sysroot\" -DCMARK_TESTS=OFF -DCMARK_SHARED=OFF ..","make","make install","cp src\/config.h sysroot\/include\/","make clean","cd ..","exit","docker rm linux"],"type":"codeListing","syntax":"sh"},{"inlineContent":[{"text":"Note that in Ubuntu the CMake flag ","type":"text"},{"type":"codeVoice","code":"--install-prefix"},{"text":" appears to not have any effect so we use ","type":"text"},{"type":"codeVoice","code":"-DCMAKE_INSTALL_PREFIX="},{"text":" instead.","type":"text"}],"type":"paragraph"},{"inlineContent":[{"text":"Also worth noting that in Ubuntu it is needed to swap the order in which the two libraries are build. This will prevent a linker error.","type":"text"}],"type":"paragraph"},{"inlineContent":[{"text":"If pkgconfig is to be referenced from within ","type":"text"},{"type":"codeVoice","code":"Package.swift"},{"text":" –not the preferred solution by this guide– then line 9 of ","type":"text"},{"type":"codeVoice","code":"sysroot\/lib\/pkgconfig\/libcmark-gfm.pc"},{"text":" should look somewhat like the following.","type":"text"}],"type":"paragraph"},{"code":["cat  sysroot\/lib\/pkgconfig\/libcmark-gfm.pc","# …","# Libs: -L${libdir} -lcmark-gfm-extensions -lcmark-gfm","# …"],"type":"codeListing","syntax":"sh"},{"anchor":"Create-an-Xcode-Framework","level":2,"type":"heading","text":"Create an Xcode Framework"},{"inlineContent":[{"text":"We will need to do this individually for each of the libraries using a Mac.","type":"text"}],"type":"paragraph"},{"anchor":"Main-library","level":3,"type":"heading","text":"Main library"},{"code":["mkdir build","xcodebuild -create-xcframework -library build-macos\/libcmark-gfm.a -headers build-macos-x86_64\/sysroot\/include -output build\/cmark-gfm.xcframework"],"type":"codeListing","syntax":"sh"},{"inlineContent":[{"type":"text","text":"Xcode Frameworks do not officially support Linux as a platform but we can manually build it in."}],"type":"paragraph"},{"code":["cp -Rp build\/cmark-gfm.xcframework\/macos-arm64_x86_64 build\/cmark-gfm.xcframework\/linux-x86_64","rm build\/cmark-gfm.xcframework\/linux-x86_64\/libcmark-gfm.a","cp build-linux\/sysroot\/lib\/libcmark-gfm.a build\/cmark-gfm.xcframework\/linux-x86_64"],"type":"codeListing","syntax":"sh"},{"inlineContent":[{"type":"text","text":"Edit the property so that it contains the following snippet."}],"type":"paragraph"},{"code":["cat build\/cmark-gfm.xcframework\/Info.plist","# …","# <plist version=\"1.0\">","# <dict>","# \t<key>AvailableLibraries<\/key>","# \t<array>","# \t\t<dict>…<\/dict>","# \t\t<dict>","# \t\t\t<key>HeadersPath<\/key>","# \t\t\t<string>Headers<\/string>","# \t\t\t<key>LibraryIdentifier<\/key>","# \t\t\t<string>linux-x86_64<\/string>","# \t\t\t<key>LibraryPath<\/key>","# \t\t\t<string>libcmark-gfm.a<\/string>","# \t\t\t<key>SupportedArchitectures<\/key>","# \t\t\t<array>","# \t\t\t\t<string>x86_64<\/string>","# \t\t\t<\/array>","# \t\t\t<key>SupportedPlatform<\/key>","# \t\t\t<string>linux<\/string>","# \t\t<\/dict>","# \t<\/array>","# \t…","# <\/dict>","# <\/plist>"],"type":"codeListing","syntax":"sh"},{"inlineContent":[{"type":"text","text":"Compress it with Zip."}],"type":"paragraph"},{"code":["cd build","zip -Xr cmark-gfm.xcframework.zip cmark-gfm.xcframework","cd .."],"type":"codeListing","syntax":"sh"},{"anchor":"Extensions-library","level":3,"type":"heading","text":"Extensions library"},{"inlineContent":[{"type":"text","text":"We need to build a separate framework for the extensions part. The process is analogous to the that for main library."}],"type":"paragraph"},{"code":["xcodebuild -create-xcframework -library build-macos\/libcmark-gfm-extensions.a -output build\/cmark-gfm-extensions.xcframework","cp -Rp build\/cmark-gfm-extensions.xcframework\/macos-arm64_x86_64 build\/cmark-gfm-extensions.xcframework\/linux-x86_64","rm build\/cmark-gfm-extensions.xcframework\/linux-x86_64\/libcmark-gfm-extensions.a","cp build-linux\/sysroot\/lib\/libcmark-gfm-extensions.a build\/cmark-gfm-extensions.xcframework\/linux-x86_64","","cat build\/cmark-gfm-extensions.xcframework\/Info.plist","# …","# <plist version=\"1.0\">","# \t\t<dict>","# \t\t\t<key>LibraryIdentifier<\/key>","# \t\t\t<string>linux-x86_64<\/string>","# \t\t\t<key>LibraryPath<\/key>","# \t\t\t<string>libcmark-gfm-extensions.a<\/string>","# \t\t\t<key>SupportedArchitectures<\/key>","# \t\t\t<array>","# \t\t\t\t<string>x86_64<\/string>","# \t\t\t<\/array>","# \t\t\t<key>SupportedPlatform<\/key>","# \t\t\t<string>linux<\/string>","# \t\t<\/dict>","# \t<\/array>","# \t…","# <\/dict>","# <\/plist>","","cd build","zip -Xr cmark-gfm-extensions.xcframework.zip cmark-gfm-extensions.xcframework","cd .."],"type":"codeListing","syntax":"sh"},{"anchor":"Distributing","level":3,"type":"heading","text":"Distributing"},{"inlineContent":[{"type":"text","text":"The Zip files are suitable for uploading to the Web. On GitHub they can be attached to a release."}],"type":"paragraph"},{"anchor":"Generate-checksums","level":3,"type":"heading","text":"Generate checksums"},{"inlineContent":[{"type":"text","text":"For users to be able to use these framework a checksum needs to be generated."}],"type":"paragraph"},{"code":["cd build","touch Package.swift","swift package compute-checksum cmark-gfm.xcframework.zip > cmark-gfm.checksum","swift package compute-checksum cmark-gfm-extensions.xcframework.zip > cmark-gfm-extensions.checksum","rm Package.swift","cd .."],"type":"codeListing","syntax":"sh"},{"anchor":"Consuming-the-Xcode-Frameworks","level":2,"type":"heading","text":"Consuming the Xcode Frameworks"},{"inlineContent":[{"text":"The generated checksums can be used for using the XCFrameworks in binary target declarations.","type":"text"}],"type":"paragraph"},{"code":["let package = Package(","    name: \"GFMarkdown\",","    …","    targets: [","        .binaryTarget(name: \"cmark-gfm\",","            url: \"https:\/\/github.com\/swiftysites\/gfmarkdown\/releases\/download\/1.0.0\/cmark-gfm.xcframework.zip\", checksum: \"f61664009f3fe1f3b88100a7a886682043ab7a234167bf579068472fe4472bec\"","        ),","        .binaryTarget(name: \"cmark-gfm-extensions\",","            url: \"https:\/\/github.com\/swiftysites\/gfmarkdown\/releases\/download\/1.0.0\/cmark-gfm-extensions.xcframework.zip\", checksum: \"97f674f4622bae79498ba835295d7dfa33b1de2989f29db0d0c17ec339ac0149\"","        ),","        .target(","            name: \"CMarkGFMPlus\",","            dependencies: [\"cmark-gfm\", \"cmark-gfm-extensions\"],","            …","        ),","        …","    ]","    …",")"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"type":"text","text":"Alternativelly local paths to the un-archived frameworks can be used for development purposes."}],"type":"paragraph"},{"code":["let package = Package(","    …","    targets: [","        .binaryTarget(name: \"cmark-gfm\",","            path: \"cmark-gfm\/build\/cmark-gfm.xcframework\"","        ),","        .binaryTarget(name: \"cmark-gfm-extensions\",","            path: \"cmark-gfm\/build\/cmark-gfm-extensions.xcframework\"","        ),","        …","    ]","    …",")"],"type":"codeListing","syntax":"swift"},{"anchor":"Linux","level":3,"type":"heading","text":"Linux"},{"inlineContent":[{"text":"In order to use the Xcode Frameworks from Linux we need to add a few conditional settings as well as some unsafe flags to our package declaration.","type":"text"}],"type":"paragraph"},{"code":["let ARTIFACT_FRAGMENT = \".build\/artifacts\/GFMarkdown\"","let ARTIFACT_FRAGMENT_LOWERCASE = \".build\/artifacts\/gfmarkdown\"","","let package = Package(","    name: \"GFMarkdown\",","    targets: [","        …","        .target(","            name: \"CMarkGFMPlus\",","            dependencies: [\"cmark-gfm\", \"cmark-gfm-extensions\"],","            cSettings: [","                .unsafeFlags([","                    \"-I\\(ARTIFACT_FRAGMENT)\/cmark-gfm.xcframework\/linux-x86_64\/Headers\",","                    \"-I\\(ARTIFACT_FRAGMENT_LOWERCASE)\/cmark-gfm.xcframework\/linux-x86_64\/Headers\",","                ], .when(platforms: [.linux]))","            ],","            linkerSettings: [","                .unsafeFlags([","                    \"-L ..\/..\/\\(ARTIFACT_FRAGMENT)\/cmark-gfm.xcframework\/linux-x86_64\",","                    \"-L ..\/..\/\\(ARTIFACT_FRAGMENT_LOWERCASE)\/cmark-gfm.xcframework\/linux-x86_64\"","                    ], .when(platforms: [.linux])),","                .unsafeFlags([","                    \"-L ..\/..\/\\(ARTIFACT_FRAGMENT)\/cmark-gfm-extensions.xcframework\/linux-x86_64\",","                    \"-L ..\/..\/\\(ARTIFACT_FRAGMENT_LOWERCASE)\/cmark-gfm-extensions.xcframework\/linux-x86_64\",","                    ], .when(platforms: [.linux])),","                .linkedLibrary(","                    \"cmark-gfm-extensions\", .when(platforms: [.linux])","                ),","                .linkedLibrary(\"cmark-gfm\", .when(platforms: [.linux]))","            ]","        ),","        …","    ]","    …",")"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"type":"text","text":"It is important for the extensions library "},{"type":"codeVoice","code":"cmark-gfm-extensions"},{"type":"text","text":" to be declared "},{"type":"emphasis","inlineContent":[{"type":"text","text":"before"}]},{"type":"text","text":" the main "},{"type":"codeVoice","code":"cmark-gfm"},{"type":"text","text":" library."}],"type":"paragraph"},{"anchor":"Unsafe-flags","level":4,"type":"heading","text":"Unsafe flags"},{"inlineContent":[{"text":"Note that the use of unsafe flags will restrict the usage of the entire product in a way that it can only be added to an external Swift Package declaration with a specific revision tag.","type":"text"}],"type":"paragraph"},{"code":["let package = Package(","    name: \"SwiftySites\",","    …","    dependencies: [","        .package(url: \"https:\/\/github.com\/swiftysites\/gfmarkdown\", .revision(\"1.0.1\")),","        …","    ],","    …",")"],"type":"codeListing","syntax":"swift"},{"anchor":"Testing-in-Linux","level":4,"type":"heading","text":"Testing in Linux"},{"inlineContent":[{"type":"text","text":"The use of "},{"type":"codeVoice","code":"ARTIFACT_FRAGMENT_LOWERCASE"},{"type":"text","text":" in the package definition is related to the fact that the artifact takes the name of the local folder when running tests."}],"type":"paragraph"},{"code":["cd gfmarkdown","swift test","","# Will only work if ARTIFACT_FRAGMENT_LOWERCASE == \".build\/artifacts\/gfmarkdown\" inside Package.swift.",""],"type":"codeListing","syntax":"sh"},{"anchor":"Clean-up","level":2,"type":"heading","text":"Clean up"},{"code":["rm -rf build build-macos build-linux build-macos-x86_64 build-macos-arm64 cmark-gfm-extensions.xcframework cmark-gfm-extensions.xcframework.zip cmark-gfm.xcframework cmark-gfm.xcframework.zip"],"type":"codeListing","syntax":"sh"},{"anchor":"Building-the-Swift-project","level":2,"type":"heading","text":"Building the Swift project"},{"inlineContent":[{"text":"Once the dependencies are built and their corresponding binaries deployed, build the Swift project the usual way. Xcode can be used or the command line on both Mac or Linux.","type":"text"}],"type":"paragraph"},{"code":["swift build"],"type":"codeListing","syntax":"sh"}],"kind":"content"}],"schemaVersion":{"minor":3,"major":0,"patch":0},"variants":[{"traits":[{"interfaceLanguage":"swift"}],"paths":["\/documentation\/gfmarkdown\/building"]}],"references":{"doc://GFMarkdown/documentation/GFMarkdown":{"url":"\/documentation\/gfmarkdown","role":"collection","abstract":[{"text":"Convert GitHub Flavored Markdown to HTML easily with the ","type":"text"},{"type":"codeVoice","code":"@Markdown"},{"type":"text","text":" property wrapper. Optionally customize every CMark option and GFM extension available."}],"type":"topic","kind":"symbol","title":"GFMarkdown","identifier":"doc:\/\/GFMarkdown\/documentation\/GFMarkdown"},"https://github.com/github/cmark-gfm":{"url":"https:\/\/github.com\/github\/cmark-gfm","identifier":"https:\/\/github.com\/github\/cmark-gfm","titleInlineContent":[{"text":"cmark-gfm","type":"text"}],"title":"cmark-gfm","type":"link"}}}